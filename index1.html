<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- may fix scroll zoom, but brings 100% height issue?  -->
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GA Foster Placement Intensity Map v0.1</title>

    <style>
        #map { height: 100%; }
        /* Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        .infoBox {
            color: white;
            font-size: 13px;
            white-space: nowrap;
        }
    </style>

    <script type="text/javascript">
        var map, ctylayer, infoWindow, hoverWindow, heatmap;
        //var ctyurl = 'https://loghlr.github.io/USCountyOverlays1/layers/GA1.json';
        var ctyurl = 'layers/GA1.json';
        //var hmlayerfield = 'In Foster Care 2017-12-08';
        var hmlayerfield = 'With Non-Family 2017-12-08';
        var cofipsselected = undefined, cofipsname = undefined;

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });

          // dark theme for the map accentuates the heatmap layer, see https://developers.google.com/maps/documentation/javascript/styling
          var dms = new google.maps.StyledMapType(darkmapstyle, {
            name: 'Dark Map'
          })
          map.mapTypes.set('darkmap', dms);
          map.setMapTypeId('darkmap');

          // build county polygon overlay, see https://developers.google.com/maps/documentation/javascript/reference/data
          ctylayer = new google.maps.Data({
            map: map,
            style: {
              clickable: true,
              strokeColor: 'white',
              strokeWeight: 1,
              fillOpacity: 0,
            }
          });
          // set map bounds to ctylayer bounds, see: https://stackoverflow.com/questions/24401240/how-to-get-latlngbounds-of-feature-polygon-geometry-in-google-maps-v3
          function getBounds() {
            var bounds = new google.maps.LatLngBounds();
            ctylayer.forEach(function(f) {
              f.getGeometry().forEachLatLng(function(path) {
                bounds.extend(path);
                //console.log('bounds: '+bounds);
              })
            });
            map.fitBounds(new google.maps.LatLngBounds(bounds.getSouthWest(), bounds.getNorthEast()), 0.6);
          }
          // goejson more efficient than kml or others
          ctylayer.loadGeoJson(ctyurl, {}, getBounds);

          infoWindow = new google.maps.InfoWindow();
          // InfoWindow capturing mousewheel events intended for map. can't seem to remove listener. switch to https://github.com/googlemaps/v3-utility-library/tree/master/infobox
          InfoBox.init() ; // infobox dependent on google.maps, so load here.
          hoverWindow = new InfoBox({
              disableAutoPan: true,
              enableEventPropagation: true,
              alignBottom: true,
              maxWidth: 0,
              xboxStyle: {
                  color: 'white',
              },
              closeBoxURL: '',
          });

          ctylayer.addListener('click', showHeatmap);
          //ctylayer.addListener('mouseover', showName); // captures entry to polygon only
          ctylayer.addListener('mousemove', showName);
          ctylayer.addListener('mouseout', hideName);

          // instantiate (empty) heatmap layer
          heatmap = new google.maps.visualization.HeatmapLayer({
            map: map,
            radius: 0.10,
            dissipating: false,
          });
        }

        // setting heatmap layer data, geojson layer properties, see https://developers.google.com/maps/documentation/javascript/examples/layer-data-event
        function getHeatmapData( cofips, fd2 ) {
          var freqtot = 0;
          var h1 = fd2.remcofips.reduce(function(y,x,i,z) {
              if( x==cofips ) {
                  var loc = new google.maps.LatLng(fd2.plczctalat[i], fd2.plczctalon[i]);
                  //console.log( loc.lat()+','+loc.lng()+','+fd2[hmlayerfield][i] );
                  if( fd2[hmlayerfield][i] > 1 ) {
                      y.push({ location: loc, weight: fd2[hmlayerfield][i] });
                  } else if( fd2[hmlayerfield][i] == 1 ) {
                      y.push(loc);
                  }
                  freqtot += fd2[hmlayerfield][i] ;
              }
              return y;
          }, [])
          return { total: freqtot, data: h1 } ;
        }
        // county click event handler:
        function showHeatmap(event) {
          hoverWindow.close();
          cofipsselected = event.feature.getProperty('GEO_ID').substr(-5);
          cofipsname = event.feature.getProperty('NAME') + ' ' + event.feature.getProperty('LSAD');
          updateHeatmap(hmlayerfield);
          infoWindow.setPosition(event.latLng);
          infoWindow.open(map);
        }

        // callback for select list in infoWindow:
        function updateHeatmap( hmlayerfield1 ) {
          hmlayerfield = hmlayerfield1;
          var hm = getHeatmapData( cofipsselected, fd1.data );
          heatmap.setData( hm.data );

          //var hmlayerfields = Object.keys(fd1.data).filter( function(x) {return /^[^rp]/.test(x)} ) // not ^rem|plc fields
          var hmlayerfields = Object.keys(fd1.units);
          var msg = cofipsname;
          msg += ': Placement Concentrations of ';
          if( fd1.units[hmlayerfield] == 'Dollars' ) {
              msg += '$' + hm.total.toFixed(0) + '<br>';
          } else {
              msg += hm.total + '<br>' + fd1.units[hmlayerfield] + ' ';
          }
          msg += '<select onChange="javascript:updateHeatmap(this.options[this.selectedIndex].value);">';
          hmlayerfields.forEach( function(x) {
              msg += '<option' + ((x==hmlayerfield)?' selected>':'>') + x + '</option>';
          });
          msg += '</select>';
          infoWindow.setContent(msg);
        }

        // county mousein event handler (show name)
        var prevhovermsg = undefined;
        function showName(event) {
          var msg = event.feature.getProperty('NAME') + ' ' + event.feature.getProperty('LSAD');
          if( msg == prevhovermsg ) { // only show once when 2+ mousemove events
              hoverWindow.setContent(msg);
              hoverWindow.setPosition(event.latLng); // using bound.getCenter fails with non-convex shapes.
              hoverWindow.open(map);
          }
          prevhovermsg = msg;
        }
        function hideName(event) {
          hoverWindow.close();
          hoverWindow.setContent(undefined);
        }

    </script>
</head>

<body>
<div id="map"></div>
<script type="text/javascript" src="GARemPlc1.js"> // loads foster care placement lat/lon into fd1. </script>
<script type="text/javascript" src='darkmapstyle.js'></script>
<script type="text/javascript" src='infobox.js'></script>

<!-- Replace key with your API key, google's: AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk. For heatmaps: &libraries=visualization-->
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=visualization&key=AIzaSyAN9K29KRiNUiLiM88oJnHGqnmTqLotNiM"></script>
</body>

