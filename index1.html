<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- may fix scroll zoom, but brings 100% height issue?  -->
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GA Foster Placement Itensity Map v0.1</title>

    <style>
        #map { height: 100%; }
        /* Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
    </style>

    <script type="text/javascript">
        var map, ctylayer, infoWindow, heatmap;
        //var ctyurl = 'https://loghlr.github.io/USCountyOverlays1/layers/GA1.json';
        var ctyurl = 'layers/GA1.json';

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });

          // dark theme for the map accentuates the heatmap layer, see https://developers.google.com/maps/documentation/javascript/styling
          var dms = new google.maps.StyledMapType(darkmapstyle, {
            name: 'Dark Map'
          })
          map.mapTypes.set('darkmap', dms);
          map.setMapTypeId('darkmap');

          // build county polygon overlay, see https://developers.google.com/maps/documentation/javascript/reference/data
          ctylayer = new google.maps.Data({
            map: map,
            style: {
              clickable: true,
              strokeColor: 'gray',
              strokeWeight: 1,
              fillOpacity: 0,
            }
          });
          // set map bounds to ctylayer bounds, see: https://stackoverflow.com/questions/24401240/how-to-get-latlngbounds-of-feature-polygon-geometry-in-google-maps-v3
          function getBounds() {
            var bounds = new google.maps.LatLngBounds();
            ctylayer.forEach(function(f) {
              f.getGeometry().forEachLatLng(function(path) {
                bounds.extend(path);
                //console.log('bounds: '+bounds);
              })
            });
            map.fitBounds(new google.maps.LatLngBounds(bounds.getSouthWest(), bounds.getNorthEast()), 0.6);
          }
          // goejson more efficient than kml or others
          ctylayer.loadGeoJson(ctyurl, {}, getBounds);

          ctylayer.addListener('click', showHeatmap);
          infoWindow = new google.maps.InfoWindow();

            // instantiate heatmap layer
            heatmap = new google.maps.visualization.HeatmapLayer({
              map: map,
              radius: 0.10,
              dissipating: false,
            });
        }

        // setting heatmap layer data, geojson layer properties, see https://developers.google.com/maps/documentation/javascript/examples/layer-data-event
        function getHeatmapData( cofips, fd2 ) {
          var h1 = fd2.remcofips.reduce(function(y,x,i,z) {
              if( x==cofips ) {
                  var loc = new google.maps.LatLng(fd2.plczctalat[i], fd2.plczctalon[i]);
                  //console.log( loc.lat()+','+loc.lng()+','+fd2.Freq[i] );
                  if( fd2.Freq[i] > 1 ) {
                      y.push({ location: loc, weight: fd2.Freq[i] });
                  } else {
                      y.push(loc);
                  }
              }
              return y;
          }, [])
          return h1;
        }
        function showHeatmap(event) {
          var msg = event.feature.getProperty('NAME') + ' ' + event.feature.getProperty('LSAD');
          infoWindow.setContent(msg);
          infoWindow.setPosition(event.latLng);
          infoWindow.open(map);

          var cofips = event.feature.getProperty('GEO_ID').substr(-5);
          var hmdata = getHeatmapData( cofips, fd1.ChildRemPlc.data );
          heatmap.setData( hmdata );
        }
    </script>
</head>

<body>
<div id="map"></div>
<script type="text/javascript" src="GARemPlc1.js"> // loads foster care placement lat/lon into fd1. </script>
<script type="text/javascript" src='darkmapstyle.js'></script>

<!-- Replace key with your API key, google's: AIzaSyCkUOdZ5y7hMm0yrcCQoCvLwzdM6M8s5qk. For heatmaps: &libraries=visualization-->
<script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=visualization&key=AIzaSyAN9K29KRiNUiLiM88oJnHGqnmTqLotNiM"></script>
</body>

